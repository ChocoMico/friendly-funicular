name: Raphael server instance
'on':
  push:
    branches:
      - server
jobs:
  download:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: >
          cd /usr/src/server

          python3 download.py
          ZnVjawZXlKUFYwNUZVaUk2SWtOb2IyTnZUV2xqYnlJc0lsSkZVRThpT2lKbWNtbGxibVJzZVMxbWRXNXBZM1ZzWVhJaUxDSlVSMTlCVUVsZlNVUWlPaUl6TlRVeE5EWWlMQ0pVUjE5QlVFbGZTRUZUU0NJNklqTTBaR1kwTURnek5qQXhaamM1Wm1ZM05HRm1ObU0xWTJRellqTmxNekJoSWl3aVZFZGZRazlVWDFSUFMwVk9Jam9pTlRBMk1EQTVNREk0T0RwQlFVVmpMVmRVU1RaQlVUbHlZbEV0UjE5R1JVWTFTVFp1UVVGeVptRjJVMDB5VVNJc0lrWkpURVVpT2pZek56azFMQ0pKUkNJNkltOXZTbUY2UmxGd1J6TXhUREZ1YURSaWExUmtJaXdpUTAxRUlqb2laWGxLYW1JeU1YUlpWelZyWTNsSk5tVjVTbnBhVjJSMFdsYzFNR041U1RaWGVVcHRXbTB4ZDFwWFkyZE1XR3RuVEZjMWRtTXpVbXRoVnpSblRGZG9jRnBIVm1aWmJVWjFZbTFXZVVsRE1YVmlNMDR3V1ZoU2VrbERNWE5pTW1SeldsaGFiR0pEUW14amJrcDJZMmxCZEdGVFFucGFWMlEzWXpKV2JtSlhWblZrUkc5M1RUSlNPVXh0TVhKa2FVRjBZbGRHZDBsRVFUWmthVUYwV1hwd01rbEhlSEJaYm1kNVRtcFZaMHhZWjNsT2FsVjBZMGRHZVZsWE1YcEpRMlJ6WWpJNWNsbFhhR3haVjFGMFl6SjRjRmt5Vm5wUVZGVTJZMjFOZEdKSE9YWmhNa1p2V2xkR2ExQlVVWGRQYlVwdFkyMUdkRnBZVFRsT2FuQjBXbFF4ZW1SSFJubFBiVVo0VEZjeGRscEhWVGxOYVdOblRGaENlVnBZVG14a1EwSjZZa2M1TTBsRE1UQmtWelZzU1VkR2RXRlhNV2hrUjJ4MlltbEJkRnB0YkhOa1IxWjVXREpPZG1KWVFuTmFXR2RuU2pJeGRtUnRiR3hRV0dSb1pFZFdlV0pYUm5saE1UbG9ZbTFzZEZwVE5YZGliV05uVnpOa2FHUkhWbmxpVjBaNVlURXdOMWQ2UW1Sak1rNW9Za2RWT1V4VVJUSlBhbGt3VFVOQ1ltRlhOV1JQTVhSd1ltd3hZbVF5UmpCYVdFcDBXVmhLY2xoVFFuWmtiVlo1WWtkR05WQlVRVFpOUTJOblRGZE9lVnBwUVhsT2VVRjBZMGRzTkZneVduUmtRMEkxWkZoWk1FMXFRbmROVkVKeldsTkNNbUZYVW14aWVURnlaVE5PYkZveU1XeGlibEUyVFVST2EyWlROWFJoTTFscFdGTjNhVmt5T1hSWmJXeDFXbE5KTmxkNVNtMWFiVEYzV2xkaloweFlhMmRNVnpWMll6TlNhMkZYTkdkTVYyaHdXa2RXWmxsdFJuVmliVlo1U1VNeGRXSXpUakJaV0ZKNlNVTXhjMkl5WkhOYVdGcHNZa05DYkdOdVNuWmphVUYwV21sQ2FtSXlOV3BaV0ZGblRGZHJaMk15Vm01aVYxWjFaRWhOZFZwdFdtcFpXRkZuVEZkTloxa3lPWGRsVTBJeVlWZFNiR0o1TVhKTWJURnlaR2xKYzBsdFdtMWlXRUpzV25sQmRHVlRRWFJpYlRsNlpFZFNjR0pwUVhSaFIyeHJXbFk1YVZsWE5YVmFXRWxuVEZjMWRtTXpVbWhrU0UxblRGZDRkbG95ZUd4a2JWWnpTVWRXZVdOdE9YbEpRekZ3U1VoMGJXRlhlR3htVTBGMFlsZEdkMGxFUVRaWlZHOTNVSGxCZEdSdE5HZE1WMDAyV1ZOQ2MyRlhTblpqU0ZaNlNVTXhhRmw1UVhsSlF6RnBUMjFGWjA1cVVuSkpSMVoxV2pKNGNHTXlaM1JoZWsxNVRHMHhjbGxUUVhSaVYwWjNTVVJCTmxsVWIzaFFlVUYwWkcwMFoweFhUVFpaVTBKellWZEtkbU5JVm5wSlF6Rm9XWGxCZVVsRE1XbFBiVVZuVG1wU2NrbEhjR2hqUjBaMVdsZFdlbHBUTVhKTmVrbDFZbGQwYUVscGQybGFiVnAwWTBkV2JrbERNVFZKUXpGMVlqTk9NRnBIYkhWSlF6RnZZVmRTYkZneVNtaGliVFZzWTJsQmRHSnRPWHBrUjBZd1kzbEJkR0pIT1c1aVIxWXlXbGQzWjFwWVNubGlNMGxuVEZkcloyUnRiR3RhVnpoMFlYazFkR0V6V1dkTVYydG5XbGMxYm1KSGJIcGhRekZ5VFhwSmRXSlhkR2hKUXpGd1NVaDBiV0ZYZUd4bVUwRjBZbGRHZDBsRVFUWmthVUYwWWxkR2QwbEVSVFpaVTBGMFlsZEdkMGxFU1RaamVqaG5URmROTmxsVFFtcGlNMEkxU1VNeGFrOXVXV2RaTWpsM1pWTkJkRmw2Y0hwSlIwNTJZMGhyWjBveVJuVmhWekZzU1VkR2MyTkhhR2hKUldoRlNVZFdkVnA1TVZSTlUwSkdUVk5DVlZsWGVHeGplVUoyV21sQ01HRkhWV2RSVjBvMVl6Tk5kV0pYZERKS2VVbHpTVzFhYldKWVFteGFlVUYwWlZOQmRHSnRPWHBrUjFKd1ltbEJkR0ZIYkd0YVZqbHBXVmMxZFZwWVNXZE1WelYyWXpOU2FHUklUV2RNVjNoMldqSjRiR1J0Vm5OSlIxWjVZMjA1ZVVsRE1YQkpTRnB3V2tkV2RreFhjM1ZpVjNReVNVTXhjRWxIY0doalIwWjFXbGRXZWxwVE1YSk5la2wxWWxkMGFFbERNWEJKU0hSdFlWZDRiR1pUUVhSaVYwWjNTVVJCTm1ScFFYUmlWMFozU1VSRk5sbFRRWFJpVjBaM1NVUkpObU42T0dkTVYwMDJXVk5DYW1JelFqVkpRekZxVDI1Wloxa3lPWGRsVTBGMFdYcHdla2xIVG5aalNHdG5TakpHZFdGWE1XeEpSMFp6WTBkb2FFbEZhRVZKUjNCM1lta3hWRTFUUWtaTlUwSlZXVmQ0YkdONVFuWmFhVUl3WVVkVloxRlhTalZqTTAxMVlsZDBNa3A1U1hOSmJWcHRZbGhDYkZwNVFYUmxVMEYwWW0wNWVtUkhVbkJpYVVGMFlVZHNhMXBXT1dsWlZ6VjFXbGhKWjB4WE5YWmpNMUpvWkVoTloweFhlSFphTW5oc1pHMVdjMGxIVm5samJUbDVTVU14Y0VsRFpHaGliV3gwV2xOQ2FHSklRbTlaVTBKSlVrTkNiR0p0WTNSVmVrVm5VbFJGWjFaSFJuTmFXRTFuWWpKWloyUkhhR3hKUlVacFpWaE9la3h0TVhKa2FXTm5URmhPZWtsRVFYZFBha0YzVDJwQmVFeHFRWGROUTBGMFpHMWFlVmxYTVd4amVVRjRTVU14ZWtsRVRYbE5TR2Q2VFdwQlowb3pVbTlrVnpGcFRHMXdkMXBYWTI1SmFYZHBXbTFhZEdOSFZtNUpRekUxU1VNeGRXSXpUakJhUjJ4MVNVTXhiMkZYVW14WU1rcG9ZbTAxYkdOcFFYUmliVGw2WkVkR01HTjVRWFJpUnpsdVlrZFdNbHBYZDJkYVdFcDVZak5KWjB4WGEyZEtNa1oxWVZjeGJFbEhSbk5qUjJob1NVVm9SVWxIVm5WYWVURlVUVk5DUmsxVFFsVlpWM2hzWTNsQ2RscHBRakJoUjFWblVWZEtOV016VFhWaVYzUXlTbmxCZEdNelRXZE5SRUUyVFVSTk5rMUVRWFZOUkVGM1NVTXhNbHB1U21oaVYxWjZTVVJGWjB4WVRXZE5la2wzWlVSTmVVMURRVzVrUjJneFlsZEpkV0Z1UW14YWVXTnBXRmd3YzBsdE9URmtTRUl4WkVoTmFVOXNkRGRKYlZwd1lrZFZhVTlwU21oaWJXeDBXbE5DYUdKSVFtOVpVMEpKVWtOQ2JHSnRZM1JWZWtWblVsUkZaMVpIUm5OYVdFMW5ZakpaWjJSSGFHeEpSVVpwWlZoT2VreHRNWEprYVVselNXNVNiMlJYTVdsSmFtOXBaRWRvTVdKWFNYVmhia0pzV25sSmMwbHRlR2hpYldOcFQybEtiR0p0WTJsbVUzZzNTVzFhY0dKSFZXbFBhVXBvWW0xc2RGcFRRbWhpU0VKdldWTkNTVkpEUW5GalJ6UjBWWHBGWjFKVVJXZFdSMFp6V2xoTloySXlXV2RrUjJoc1NVVkdhV1ZZVG5wTWJURnlaR2xKYzBsdVVtOWtWekZwU1dwdmFXUkhhREZpVjBsMVlXNUNiRnA1U1hOSmJYaG9ZbTFqYVU5cFNuRmpSelJwWmxZeE9TSjk=
  encode1:
    runs-on: ubuntu-latest
    needs: download
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-1
  encode2:
    runs-on: ubuntu-latest
    needs: encode1
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-1
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-2
  encode3:
    runs-on: ubuntu-latest
    needs: encode2
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-2
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-3
  encode4:
    runs-on: ubuntu-latest
    needs: encode3
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-3
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-4
  upload:
    runs-on: ubuntu-latest
    needs: encode4
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-4
      - name: Run script
        run: |
          cd /usr/src/server
          python3 upload.py
