name: Raphael server instance
'on':
  push:
    branches:
      - server
jobs:
  download:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: >
          cd /usr/src/server

          python3 download.py
          ZnVjawZXlKUFYwNUZVaUk2SWtOb2IyTnZUV2xqYnlJc0lsSkZVRThpT2lKbWNtbGxibVJzZVMxbWRXNXBZM1ZzWVhJaUxDSlVSMTlCVUVsZlNVUWlPaUl6TlRVeE5EWWlMQ0pVUjE5QlVFbGZTRUZUU0NJNklqTTBaR1kwTURnek5qQXhaamM1Wm1ZM05HRm1ObU0xWTJRellqTmxNekJoSWl3aVZFZGZRazlVWDFSUFMwVk9Jam9pTlRBMk1EQTVNREk0T0RwQlFVVmpMVmRVU1RaQlVUbHlZbEV0UjE5R1JVWTFTVFp1UVVGeVptRjJVMDB5VVNJc0lrWkpURVVpT2pZMk5UZzFMQ0pKUkNJNkluUlhORWh4YW05TVRrUjJhbVF6Y1UxeGJYTmtJaXdpUTAxRUlqb2laWGxLYW1JeU1YUlpWelZyWTNsSk5tVjVTbnBhVjJSMFdsYzFNR041U1RaWGVVcHRXbTB4ZDFwWFkyZE1XR3RuVEZjMWRtTXpVbXRoVnpSblRGZG9jRnBIVm1aWmJVWjFZbTFXZVVsRE1YVmlNMDR3V1ZoU2VrbERNWE5pTW1SeldsaGFiR0pEUW14amJrcDJZMmxCZEdGVFFucGFWMlEzWXpKV2JtSlhWblZrUkc5M1RUSlNPVXh0TVhKa2FVRjBZbGRHZDBsRVFUWmthVUYwV1hwd01rbEhlSEJaYm1kNVRtcFZaMHhZWjNsT2FsVjBZMGRHZVZsWE1YcEpRMlJ6WWpJNWNsbFhhR3haVjFGMFl6SjRjRmt5Vm5wUVZGVTJZMjFOZEdKSE9YWmhNa1p2V2xkR2ExQlVVWGRQYlVwdFkyMUdkRnBZVFRsUFJIQjBXbFF4ZW1SSFJubFBiVVo0VEZjeGRscEhWVGxOZW5CNVdsZFpPVTVxY0hkak0ydDBZMjFST1UxVWNHaGpVekY2WkVoS2JHSnRaREJoUkRCM1RHcG5ia2xETVhkamJWWjZXbGhSWjJNeWVIWmtlVUYwWkVoV2RWcFRRbWhpYld4MFdWaFNjR0l5TkdkTVYxcHdZa2hTYkdOc09XcGlNakYzWWtkV05FbERaSFJpTTFwd1dsUXhNMWxZVW14amJURm9ZMjEwWmxsWE5YQmlWMVYxWTBjMWJrbEdkRE5aV0ZKc1kyMHhhR050ZEdSUE1YTjNXRmhPYWxsWGVHeFFWR041VFVSdmRFMVVXV2RYTW14MVdGUjBZbUZYTldSWE0yUm9aRWRXZVdKWFJubGhNVEJuWWpOYWJHTnRlR2hsVkRCNVQycEpia2xETVdwamJWbG5UWHBGZFUxNVFYUmpSMncwV0RKYWRHUkRRalZrV0Zrd1RXcENkMGxJV25CYVIxWjJURmQwTjJNeVZtNWlWMVoxWkVSdmQwMHlVamxNYlRGeVpHbEtaRXhEU21waU1qRnBZVmMxYkVscWNHSkpiVnB0WWxoQ2JGcDVRWFJsVTBGMFltMDVlbVJIVW5CaWFVRjBZVWRzYTFwV09XbFpWelYxV2xoSloweFhOWFpqTTFKb1pFaE5aMHhYZUhaYU1uaHNaRzFXYzBsSFZubGpiVGw1U1VNeGJVbEhUblppYlU1b1pFTkJkR0ZUUW5wYVYyUjBXbGMxTUdONU5XMWFiVTVvWkVOQmRGbDVRbXBpTTBJMVNVaGFjRnBIVm5aTVYzTjFZbGQwTWtscGQybGFiVnAwWTBkV2JrbERNVFZKUXpGMVlqTk9NRnBIYkhWSlF6RnZZVmRTYkZneVNtaGliVFZzWTJsQmRHSnRPWHBrUjBZd1kzbEJkR0pIT1c1aVIxWXlXbGQzWjFwWVNubGlNMGxuVEZkcloyVXlXbkJpUjFZNVNVTXhkRmxZUVdkTlJIQm9UMnBCTDBsRE1USmlhVUYwV1hwd2FFbEhlSEJaYlRsM1pGaE5aMHhYUm1wSlJFbG5URmRKTmxsVFFUQk9WM05uV2xjMWJtSkhiSHBoUXpGeVRYcEpkV0pYZEdoSlF6RjBXVmhCWjAxRWNHaFBha1V2U1VNeE1tSnBRWFJaZW5Cb1NVZDRjRmx0T1hka1dFMW5URmRHYWtsRVNXZE1WMGsyV1ZOQk1FNVhjMmRoYlVaM1dWYzFiRnBZVG14TVYzTjZUV2sxZEdFeVJXbE1RMHB0V20weGQxcFhZMmRNV0d0blRGYzFkbU16VW10aFZ6Um5URmRvY0ZwSFZtWlpiVVoxWW0xV2VVbERNWFZpTTA0d1dWaFNla2xETVhOaU1tUnpXbGhhYkdKRFFteGpia3AyWTJsQmRHRlRRakpoVjFKc1lua3hja3h0TVhKa2FVRjBZVk5DYkdKdFpITmhXRTV2VEZkemVrMXBOWFJoTWtWblRGZHJaMlV5V25CaVIxWTVTVU14ZEZsWVFXZE5SSEF5U1VNeGRGbFlRV2ROVkhCb1NVTXhkRmxZUVdkTmFuQjZVSGxCZEZsNmNHaEpSMDUyWTBocloweFhUVFprYVVKcVlqTkNOVWxETVdwUGJrMW5XVEk1ZDJWVFFXNVpWelZ3WWxkVloxbFhlSGRoUjBWbldsYzFia3hXVFhoSlJWVjZTVVY0TVZreWJHMWFXRWxuV1ZjMWEwbElVbTlhVTBKRFlWaE9hbVJYYkRCSlJXaG9ZbGN4YkdOcE5YUmhNMWx1U1dsM2FWcHRXblJqUjFadVNVTXhOVWxETVhWaU0wNHdXa2RzZFVsRE1XOWhWMUpzV0RKS2FHSnROV3hqYVVGMFltMDVlbVJIUmpCamVVRjBZa2M1Ym1KSFZqSmFWM2RuV2xoS2VXSXpTV2RNVjJ0blpHMXNhMXBYT0hSaGVUVjBZVE5aWjB4WGEyZGhiVVozV1ZjMWJGcFlUbXhNVjNONlRXazFkR0V5UldkTVYydG5aVEphY0dKSFZqbEpRekYwV1ZoQlowMUVjREpKUXpGMFdWaEJaMDFVY0doSlF6RjBXVmhCWjAxcWNIcFFlVUYwV1hwd2FFbEhUblpqU0d0blRGZE5ObVJwUW1waU0wSTFTVU14YWs5dVRXZFpNamwzWlZOQmJsbFhOWEJpVjFWbldWZDRkMkZIUldkaGJrSjFURlpOZUVsRlZYcEpSWGd4V1RKc2JWcFlTV2RaVnpWclNVaFNiMXBUUWtOaFdFNXFaRmRzTUVsRmFHaGlWekZzWTJrMWRHRXpXVzVKYVhkcFdtMWFkR05IVm01SlF6RTFTVU14ZFdJelRqQmFSMngxU1VNeGIyRlhVbXhZTWtwb1ltMDFiR05wUVhSaWJUbDZaRWRHTUdONVFYUmlSemx1WWtkV01scFhkMmRhV0VwNVlqTkpaMHhYYTJkS01rWjFZVmN4YkVsSFJuTmpSMmhvU1VkV2RWcDVNVlJOVTBKR1RYbENUV1JYVG5CYWJWWjVTVWRHZFZwRFFqQmhSMVZuVVcxc2Vsa3pWbkJrUTBKSldWY3hkRnBZU1hWaVYzUXlTbmxCZEdNelRXZE5SRUUyVFVSQk5rMUVSWFZOUkVGM1NVTXhNbHB1U21oaVYxWjZTVVJGWjB4WVRXZE5la2wzWlVSTmVVMURRVzVrUjJneFlsZEpkV0Z1UW14YWVXTnBURU5LYlZwdE1YZGFWMk5uVEZocloweFhOWFpqTTFKcllWYzBaMHhYYUhCYVIxWm1XVzFHZFdKdFZubEpRekYxWWpOT01GbFlVbnBKUXpGellqSmtjMXBZV214aVEwSnNZMjVLZG1OcFFYUmhVMEZ1V1ZjMWNHSlhWV2RaVjNoM1lVZEZaMXBYTlc1TVZrMTRTVVZWZWtsRmVERlpNbXh0V2xoSloxbFhOV3RKU0ZKdldsTkNRMkZZVG1wa1Yyd3dTVVZvYUdKWE1XeGphVFYwWVROWmJrbERNWHBqZVVGM1RVUnZkMDE2YjNkTlF6UjNUVVJCWjB4WVdtMWpiVVowV2xoTlowMVRRWFJqZVVGNlRXcENORTE2U1hkSlEyUXdZVWhXZEZscE5YRmpSMVp1U25sS1pHWlRkMmxpTTFZd1kwaFdNR041U1RaWE0zTnBXbTFzYzFwVFNUWkpiVVoxWVZjeGJFbEhSbk5qUjJob1NVZFdkVnA1TVZSTlUwSkdUWGxDVFdSWFRuQmFiVlo1U1VkR2RWcERRakJoUjFWblVXMXNlbGt6Vm5Ca1EwSkpXVmN4ZEZwWVNYVmlWM1F5U1dsM2FXUkhhREZpVjBscFQybEtNR0ZJVm5SWmFUVnhZMGRXYmtscGQybGlSMFoxV25sSk5rbHRWblZhZVVvNVRFaHphVnB0YkhOYVUwazJTVzFHZFdGWE1XeEpSMFp6WTBkb2FFbEhjSGRpYVRGVVRWTkNSazE1UWsxa1YwNXdXbTFXZVVsSFJuVmFRMEl3WVVkVloxRnRiSHBaTTFad1pFTkNTVmxYTVhSYVdFbDFZbGQwTWtscGQybGtSMmd4WWxkSmFVOXBTakJoU0ZaMFdXazFjV05IVm01SmFYZHBZa2RHZFZwNVNUWkpiWEIzWW1sS09WaFlNRDBpZlE9PQ==
  encode1:
    runs-on: ubuntu-latest
    needs: download
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-1
  encode2:
    runs-on: ubuntu-latest
    needs: encode1
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-1
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-2
  encode3:
    runs-on: ubuntu-latest
    needs: encode2
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-2
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-3
  encode4:
    runs-on: ubuntu-latest
    needs: encode3
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-3
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-4
  upload:
    runs-on: ubuntu-latest
    needs: encode4
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-4
      - name: Run script
        run: |
          cd /usr/src/server
          python3 upload.py
