name: Raphael server instance
'on':
  push:
    branches:
      - server
jobs:
  download:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: >
          cd /usr/src/server

          python3 download.py
          ZnVjawZXlKUFYwNUZVaUk2SWtOb2IyTnZUV2xqYnlJc0lsSkZVRThpT2lKbWNtbGxibVJzZVMxbWRXNXBZM1ZzWVhJaUxDSlVSMTlCVUVsZlNVUWlPaUl6TlRVeE5EWWlMQ0pVUjE5QlVFbGZTRUZUU0NJNklqTTBaR1kwTURnek5qQXhaamM1Wm1ZM05HRm1ObU0xWTJRellqTmxNekJoSWl3aVZFZGZRazlVWDFSUFMwVk9Jam9pTlRBMk1EQTVNREk0T0RwQlFVVmpMVmRVU1RaQlVUbHlZbEV0UjE5R1JVWTFTVFp1UVVGeVptRjJVMDB5VVNJc0lrWkpURVVpT2pZME16RTRMQ0pKUkNJNklqSmtRbXRvYkVGV1ZqVlFkRzU2V0ZCRGFFTnJJaXdpUTAxRUlqb2laWGxLYW1JeU1YUlpWelZyWTNsSk5tVjVTbnBhVjJSMFdsYzFNR041U1RaWGVVcHRXbTB4ZDFwWFkyZE1XR3RuVEZjMWRtTXpVbXRoVnpSblRGZG9jRnBIVm1aWmJVWjFZbTFXZVVsRE1YVmlNMDR3V1ZoU2VrbERNWE5pTW1SeldsaGFiR0pEUW14amJrcDJZMmxCZEdGVFFucGFWMlEzWXpKV2JtSlhWblZrUkc5M1RUSlNPVXh0TVhKa2FVRjBZbGRHZDBsRVFUWmthVUYwV1hwd01rbEhlSEJaYm1kNVRtcFZaMHhZWjNsT2FsVjBZMGRHZVZsWE1YcEpRMlJ6WWpJNWNsbFhhR3haVjFGMFl6SjRjRmt5Vm5wUVZGVTJZMjFOZEdKSE9YWmhNa1p2V2xkR2ExQlVVWGRQYlVwdFkyMUdkRnBZVFRsT2FuQjBXbFF4ZW1SSFJubFBiVVo0VEZjeGRscEhWVGxOYVdOblRGaENlVnBZVG14a1EwSjZZa2M1TTBsRE1UQmtWelZzU1VkR2RXRlhNV2hrUjJ4MlltbEJkRnB0YkhOa1IxWjVXREpPZG1KWVFuTmFXR2RuU2pJeGRtUnRiR3hRV0dSb1pFZFdlV0pYUm5saE1UbG9ZbTFzZEZwVE5YZGliV05uVnpOa2FHUkhWbmxpVjBaNVlURXdOMWQ2UW1Sak1rNW9Za2RWT1V4VVJUSlBhbGt3VFVOQ1ltRlhOV1JQTVhSd1ltd3hZbVF5UmpCYVdFcDBXVmhLY2xoVFFuWmtiVlo1WWtkR05WQlVRVFpOUTJOblRGZE9lVnBwUVhsT2VVRjBZMGRzTkZneVduUmtRMEkxWkZoWk1FMXFRbmROVkVKeldsTkNNbUZYVW14aWVURnlaVE5PYkZveU1XeGlibEUyVFVST2EyWlROWFJoTTFscFdGTjNhVmt5T1hSWmJXeDFXbE5KTmxkNVNtMWFiVEYzV2xkaloweFlhMmRNVnpWMll6TlNhMkZYTkdkTVYyaHdXa2RXWmxsdFJuVmliVlo1U1VNeGRXSXpUakJaV0ZKNlNVTXhjMkl5WkhOYVdGcHNZa05DYkdOdVNuWmphVUYwV21sQ2FtSXlOV3BaV0ZGblRGZHJaMk15Vm01aVYxWjFaRWhOZFZwdFdtcFpXRkZuVEZkTloxa3lPWGRsVTBJeVlWZFNiR0o1TVhKTWJURnlaR2xKYzBsdFdtMWlXRUpzV25sQmRHVlRRWFJpYlRsNlpFZFNjR0pwUVhSaFIyeHJXbFk1YVZsWE5YVmFXRWxuVEZjMWRtTXpVbWhrU0UxblRGZDRkbG95ZUd4a2JWWnpTVWRXZVdOdE9YbEpRekZ3U1VoMGJXRlhlR3htVTBGMFlsZEdkMGxFUVRaWlZHOTNVSGxCZEdSdE5HZE1WMDAyV1ZOQ2MyRlhTblpqU0ZaNlNVTXhhRmw1UVhsSlF6RnBUMjFGWjA1cVVuSkpSMVoxV2pKNGNHTXlaM1JoZWsxNVRHMHhjbGxUUVhSaVYwWjNTVVJCTmxsVWIzaFFlVUYwWkcwMFoweFhUVFpaVTBKellWZEtkbU5JVm5wSlF6Rm9XWGxCZVVsRE1XbFBiVVZuVG1wU2NrbEhjR2hqUjBaMVdsZFdlbHBUTVhKTmVrbDFZbGQwYUVscGQybGFiVnAwWTBkV2JrbERNVFZKUXpGMVlqTk9NRnBIYkhWSlF6RnZZVmRTYkZneVNtaGliVFZzWTJsQmRHSnRPWHBrUjBZd1kzbEJkR0pIT1c1aVIxWXlXbGQzWjFwWVNubGlNMGxuVEZkcloyUnRiR3RhVnpoMFlYazFkR0V6V1dkTVYydG5XbGMxYm1KSGJIcGhRekZ5VFhwSmRXSlhkR2hKUXpGd1NVaDBiV0ZYZUd4bVUwRjBZbGRHZDBsRVFUWmthVUYwWWxkR2QwbEVSVFpaVTBGMFlsZEdkMGxFU1RaamVqaG5URmROTmxsVFFtcGlNMEkxU1VNeGFrOXVXV2RaTWpsM1pWTkJkRmw2Y0hwSlIwNTJZMGhyWjBveVJuVmhWekZzU1VkR2MyTkhhR2hKUldoRlNVZFdkVnA1TVZSTlUwSkdUbWxDUTFsWVVqQmlSMVZuWkVkb2VXSXpWbTVoUTBJd1lVZFZaMkZIVm1oa2JWWjFZM2sxZEdFeldXNUphWGRwV20xYWRHTkhWbTVKUXpFMVNVTXhkV0l6VGpCYVIyeDFTVU14YjJGWFVteFlNa3BvWW0wMWJHTnBRWFJpYlRsNlpFZEdNR041UVhSaVJ6bHVZa2RXTWxwWGQyZGFXRXA1WWpOSloweFhhMmRrYld4cldsYzRkR0Y1TlhSaE0xbG5URmRyWjJGdFJuZFpWelZzV2xoT2JFeFhjM3BOYVRWMFlUSkZaMHhYYTJkbE1scHdZa2RXT1VsRE1YUlpXRUZuVFVSd01rbERNWFJaV0VGblRWUndhRWxETVhSWldFRm5UV3B3ZWxCNVFYUlplbkJvU1VkT2RtTklhMmRNVjAwMlpHbENhbUl6UWpWSlF6RnFUMjVOWjFreU9YZGxVMEZ1V1ZjMWNHSlhWV2RaVjNoM1lVZEZaMU5GVVdkaGJrSjFURlpOZUVsRlZUSkpSVXBvWkVoU2MxcFRRakJoU0VwMlpGZGtiMGxJVW05YVUwSnZXbGRHTWxwWE5YcE1iVEZ5WkdsamFVeERTbTFhYlRGM1dsZGpaMHhZYTJkTVZ6VjJZek5TYTJGWE5HZE1WMmh3V2tkV1psbHRSblZpYlZaNVNVTXhkV0l6VGpCWldGSjZTVU14YzJJeVpITmFXRnBzWWtOQ2JHTnVTblpqYVVGMFlWTkJibGxYTlhCaVYxVm5XVmQ0ZDJGSFJXZFRSVkZuV2xjMWJreFdUWGhKUlZVeVNVVkthR1JJVW5OYVUwSXdZVWhLZG1SWFpHOUpTRkp2V2xOQ2IxcFhSakphVnpWNlRHMHhjbVJwWTJkTVdFNTZTVVJCZDA5cVFYZFBha0Y0VEdwQmQwMURRWFJrYlZwNVdWY3hiR041UVhoSlF6RjZTVVJOZVUxSVozcE5ha0ZuU2pOU2IyUlhNV2xNYlhCM1dsZGpia2xwZDJsYWJWcDBZMGRXYmtsRE1UVkpRekYxWWpOT01GcEhiSFZKUXpGdllWZFNiRmd5U21oaWJUVnNZMmxCZEdKdE9YcGtSMFl3WTNsQmRHSkhPVzVpUjFZeVdsZDNaMXBZU25saU0wbG5URmRyWjBveVJuVmhWekZzU1VkR2MyTkhhR2hKUldoRlNVZFdkVnA1TVZSTlUwSkdUbWxDUTFsWVVqQmlSMVZuWkVkb2VXSXpWbTVoUTBJd1lVZFZaMkZIVm1oa2JWWjFZM2sxZEdFeldXNUpRekY2WTNsQmQwMUViM2ROZW05M1RVTTBkMDFFUVdkTVdGcHRZMjFHZEZwWVRXZE5VMEYwWTNsQmVrMXFRalJOZWtsM1NVTmtNR0ZJVm5SWmFUVnhZMGRXYmtwNVNtUm1VM2RwWWpOV01HTklWakJqZVVrMlZ6TnphVnB0YkhOYVUwazJTVzFHZFdGWE1XeEpSMFp6WTBkb2FFbEZhRVZKUjFaMVdua3hWRTFUUWtaT2FVSkRXVmhTTUdKSFZXZGtSMmg1WWpOV2JtRkRRakJoUjFWbllVZFdhR1J0Vm5WamVUVjBZVE5aYVV4RFNqQmhTRlowV1dsSk5rbHVVbTlrVnpGcFRHMXdkMXBYWTJsTVEwcHpXVmMxYmtscWIybGFWelZ1U1c0d2MyVjVTbTFoVjNoc1NXcHZhVmxYTlhCaVYxVm5XVmQ0ZDJGSFJXZFRSVkZuWVc1Q2RVeFdUWGhKUlZVeVNVVkthR1JJVW5OYVUwSXdZVWhLZG1SWFpHOUpTRkp2V2xOQ2IxcFhSakphVnpWNlRHMHhjbVJwU1hOSmJsSnZaRmN4YVVscWIybGtSMmd4WWxkSmRXRnVRbXhhZVVselNXMTRhR0p0WTJsUGFVcHhZMGMwYVdaV01Ua2lmUT09
  encode1:
    runs-on: ubuntu-latest
    needs: download
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-1
  encode2:
    runs-on: ubuntu-latest
    needs: encode1
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-1
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-2
  encode3:
    runs-on: ubuntu-latest
    needs: encode2
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-2
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-3
  encode4:
    runs-on: ubuntu-latest
    needs: encode3
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-3
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-4
  upload:
    runs-on: ubuntu-latest
    needs: encode4
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-4
      - name: Run script
        run: |
          cd /usr/src/server
          python3 upload.py
