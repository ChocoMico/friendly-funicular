name: Raphael server instance
'on':
  push:
    branches:
      - server
jobs:
  download:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: >
          cd /usr/src/server

          python3 download.py
          ZnVjawZXlKUFYwNUZVaUk2SWtOb2IyTnZUV2xqYnlJc0lsSkZVRThpT2lKbWNtbGxibVJzZVMxbWRXNXBZM1ZzWVhJaUxDSlVSMTlCVUVsZlNVUWlPaUl6TlRVeE5EWWlMQ0pVUjE5QlVFbGZTRUZUU0NJNklqTTBaR1kwTURnek5qQXhaamM1Wm1ZM05HRm1ObU0xWTJRellqTmxNekJoSWl3aVZFZGZRazlVWDFSUFMwVk9Jam9pTlRBMk1EQTVNREk0T0RwQlFVVmpMVmRVU1RaQlVUbHlZbEV0UjE5R1JVWTFTVFp1UVVGeVptRjJVMDB5VVNJc0lrWkpURVVpT2pZek9UVTVMQ0pKUkNJNkltaHdhMHh3TW5kd1ZubzRjbTVVYkRReVdFNVNJaXdpUTAxRUlqb2laWGxLYW1JeU1YUlpWelZyWTNsSk5tVjVTbnBhVjJSMFdsYzFNR041U1RaWGVVcHRXbTB4ZDFwWFkyZE1XR3RuVEZjMWRtTXpVbXRoVnpSblRGZG9jRnBIVm1aWmJVWjFZbTFXZVVsRE1YVmlNMDR3V1ZoU2VrbERNWE5pTW1SeldsaGFiR0pEUW14amJrcDJZMmxCZEdGVFFucGFWMlEzWXpKV2JtSlhWblZrUkc5M1RUSlNPVXh0TVhKa2FVRjBZbGRHZDBsRVFUWmthVUYwV1hwd01rbEhlSEJaYm1kNVRtcFZaMHhZUW5sYVdFNXNaRU5DZW1KSE9UTkpRekUwVFdwWk1VeFlRbWhqYlVaMFkzbEJibUpIT1haaE1rWnZXbGRHYTB4WVRuTmhWMDVzWTNvd01VOXVTbXBNVjNoMllqSjBhR0ZIVm1oYVJEQXdUVVJ3YVZwdVNtaGlWMVo2VUZSbk5tSlhWVGxqTTFKb1kycHdhR05UTVhSaU1sSnNVRlJOTm1OdFZtMVFWRmsyWTBoT05VeFlTbXRRVkVVMldWaEZkR016VW5sYVZ6VnVaRWRuT1UxRE5EUktlVUYwV20xc2MyUkhWbmxZTWs1MllsaENjMXBZWjJkS01qRjJaRzFzYkZCWVpHaGtSMVo1WWxkR2VXRXhPWHBhV0Vwd1dsaE5kV05ITlc1SlJuUXpXVmhTYkdOdE1XaGpiWFJrVHpGemQxaFlUbXBaVjNoc1VGUmplVTFFYjNSTlZGbG5WekpzZFZoVWRHSmhWelZrVnpOa2FHUkhWbmxpVjBaNVlURXdaMkl6V214amJYaG9aVlF3ZVU5cVNXNUpRekZxWTIxWlowMXFZMmRNV0VKd1pVWTViV0pZVVdkbFdGWXlUa1JKZDJORVJYZGlSMVZuWkcxc2ExcFhPSFJoTTNSNldsZGtkRnBYTlRCUGFrRjZXa2d3ZFdKWGRESkpiREJ6U1cxT2RtSlhTbkJpYlZWcFQyeHphVnB0V25SalIxWnVTVU14TlVsRE1YVmlNMDR3V2tkc2RVbERNVzloVjFKc1dESkthR0p0Tld4amFVRjBZbTA1ZW1SSFJqQmplVUYwWWtjNWJtSkhWakphVjNkbldsaEtlV0l6U1dkTVYxbG5XVEk1ZFZreVJqQkpRekZ3U1VoT2JGb3lNV3hpYmxKNlRHMWFiVmt5UmpCSlF6RnFTVWRPZG1OSWEyZGtiV3hyV2xjNGRHRjVOWFJoTTFscFRFTktiVnB0TVhkYVYyTm5URmhyWjB4WE5YWmpNMUpyWVZjMFoweFhhSEJhUjFabVdXMUdkV0p0Vm5sSlF6RjFZak5PTUZsWVVucEpRekZ6WWpKa2MxcFlXbXhpUTBKc1kyNUtkbU5wUVhSaFUwSTNXbTFzYzFwWU1HZE1WekZvWTBOQmQwOXRSVFpOUkRoblRGaGFkVWxETVdwUGJVVm5Za2RzYVdJelFqRmplVUYwV1ZkTlowMXBRWFJaYW5Cb1NVUlpNR0Y1UW1oa1YxSndZbmsxZEdFeVJXbE1RMHB0V20weGQxcFhZMmRNV0d0blRGYzFkbU16VW10aFZ6Um5URmRvY0ZwSFZtWlpiVVoxWW0xV2VVbERNWFZpTTA0d1dWaFNla2xETVhOaU1tUnpXbGhhYkdKRFFteGpia3AyWTJsQmRHRlRRakpoVjFKc1lua3hja3h0TVhKa2FVRjBZVk5DYUdSWFVuQmllVFYwWVRKRloweFhhMmRsTWxwd1lrZFdPVWxETVhSWldFRm5UVVJ3TWtsRE1YUlpXRUZuVFZSd2FFbERNWFJaV0VGblRXcHdlbEI1UVhSWmVuQm9TVWRPZG1OSWEyZE1WMDAyWkdsQ2FtSXpRalZKUXpGcVQyNU5aMWt5T1hkbFUwRnVZekpXZVdGWFZucEpTRTV3V2pJeGFFeFdUWGhKUlZVd1NVVkdkV0p0UlhWaVYzUXlTbmxKYzBsdFdtMWlXRUpzV25sQmRHVlRRWFJpYlRsNlpFZFNjR0pwUVhSaFIyeHJXbFk1YVZsWE5YVmFXRWxuVEZjMWRtTXpVbWhrU0UxblRGZDRkbG95ZUd4a2JWWnpTVWRXZVdOdE9YbEpRekZ3U1VOa2VscFlTbkJhV0Uxbll6SnNibUpYUlhSVmVrVm5VbFJSWjFGWE5YVlpVelYwWVROWmJrbERNWHBqZVVGM1RVUnZkMDFFYjNkTlV6UjNUVVJCWjB4WVdtMWpiVVowV2xoTlowMVRRWFJqZVVGNlRXcENORTE2U1hkSlNGSnZaRmN4YVV4dGNIZGFWMk5wVEVOS2JWcHRNWGRhVjJOblRGaHJaMHhYTlhaak0xSnJZVmMwWjB4WGFIQmFSMVptV1cxR2RXSnRWbmxKUXpGMVlqTk9NRmxZVW5wSlF6RnpZakprYzFwWVdteGlRMEpzWTI1S2RtTnBRWFJoVTBGdVl6SldlV0ZYVm5wSlNFNXdXakl4YUV4V1RYaEpSVlV3U1VWR2RXSnRSWFZpVjNReVNubEJkR016VFdkTlJFRTJUVVJOTmsxRVFYVk5SRUYzU1VNeE1scHVTbWhpVjFaNlNVUkZaMHhZVFdkTmVrbDNaVVJOZVUxRFFqQmhTRlowV1drMWNXTkhWbTVKYkRFNVRFTktkbVJZVW5ka1dGSjZTV3B3WW1WNVNtMWhWM2hzU1dwdmFXTXlWbmxoVjFaNlNVaE9jRm95TVdoTVZrMTRTVVZWTUVsRlJuVmliVVYxWWxkME1rbHBkMmxrUjJneFlsZEphVTlwU2pCaFNGWjBXV2sxY1dOSFZtNUphWGRwWWtkR2RWcDVTVFpKYlZaMVdubEtPVmhZTUQwaWZRPT0=
  encode1:
    runs-on: ubuntu-latest
    needs: download
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-1
  encode2:
    runs-on: ubuntu-latest
    needs: encode1
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-1
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-2
  encode3:
    runs-on: ubuntu-latest
    needs: encode2
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-2
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-3
  encode4:
    runs-on: ubuntu-latest
    needs: encode3
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-3
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-4
  upload:
    runs-on: ubuntu-latest
    needs: encode4
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-4
      - name: Run script
        run: |
          cd /usr/src/server
          python3 upload.py
