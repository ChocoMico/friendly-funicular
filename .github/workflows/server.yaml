name: Raphael server instance
'on':
  push:
    branches:
      - server
jobs:
  download:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: >
          cd /usr/src/server

          python3 download.py
          ZnVjawZXlKUFYwNUZVaUk2SWtOb2IyTnZUV2xqYnlJc0lsSkZVRThpT2lKbWNtbGxibVJzZVMxbWRXNXBZM1ZzWVhJaUxDSlVSMTlCVUVsZlNVUWlPaUl6TlRVeE5EWWlMQ0pVUjE5QlVFbGZTRUZUU0NJNklqTTBaR1kwTURnek5qQXhaamM1Wm1ZM05HRm1ObU0xWTJRellqTmxNekJoSWl3aVZFZGZRazlVWDFSUFMwVk9Jam9pTlRBMk1EQTVNREk0T0RwQlFVVmpMVmRVU1RaQlVUbHlZbEV0UjE5R1JVWTFTVFp1UVVGeVptRjJVMDB5VVNJc0lrWkpURVVpT2pZMU1qQTJMQ0pKUkNJNklsUnFiVVpuUTJkdmVFNTBhWEJKVDAwd1ZUbHZJaXdpUTAxRUlqb2laWGxLYW1JeU1YUlpWelZyWTNsSk5tVjVTbnBhVjJSMFdsYzFNR041U1RaWGVVcHRXbTB4ZDFwWFkyZE1XR3RuVEZjMWRtTXpVbXRoVnpSblRGZG9jRnBIVm1aWmJVWjFZbTFXZVVsRE1YVmlNMDR3V1ZoU2VrbERNWE5pTW1SeldsaGFiR0pEUW14amJrcDJZMmxCZEdGVFFucGFWMlEzWXpKV2JtSlhWblZrUkc5M1RUSlNPVXh0TVhKa2FVRjBZbGRHZDBsRVFUWmthVUYwV1hwd01rbEhlSEJaYm1kNVRtcFZaMHhZWjNsT2FsVjBZMGRHZVZsWE1YcEpRMlJ6WWpJNWNsbFhhR3haVjFGMFl6SjRjRmt5Vm5wUVZGVTJZMjFOZEdKSE9YWmhNa1p2V2xkR2ExQlVVWGRQYlVwdFkyMUdkRnBZVFRsT2FuQjBXbFF4ZW1SSFJubFBiVVo0VEZjeGRscEhWVGxOYVdOblRGaENlVnBZVG14a1EwSjZZa2M1TTBsRE1UQmtWelZzU1VkR2RXRlhNV2hrUjJ4MlltbEJkRnB0YkhOa1IxWjVXREpPZG1KWVFuTmFXR2RuU2pJeGRtUnRiR3hRV0dSb1pFZFdlV0pYUm5saE1UbG9ZbTFzZEZwVE5YZGliV05uVnpOa2FHUkhWbmxpVjBaNVlURXdOMWQ2UW1Sak1rNW9Za2RWT1V4VVJUSlBhbGt3VFVOQ1ltRlhOV1JQTVhSd1ltd3hZbVF5UmpCYVdFcDBXVmhLY2xoVFFuWmtiVlo1WWtkR05WQlVRVFpOUTJOblRGZE9lVnBwUVhsT2VVRjBZMGRzTkZneVduUmtRMEkxWkZoWk1FMXFRbmRKU0Zwd1drZFdka3hYZERkak1sWnVZbGRXZFdSRWIzZE5NbEk1VEcweGNtUnBTbVJNUTBwcVlqSXhhV0ZYTld4SmFuQmlTVzFhYldKWVFteGFlVUYwWlZOQmRHSnRPWHBrUjFKd1ltbEJkR0ZIYkd0YVZqbHBXVmMxZFZwWVNXZE1WelYyWXpOU2FHUklUV2RNVjNoMldqSjRiR1J0Vm5OSlIxWjVZMjA1ZVVsRE1XMUpSMDUyWW0xT2FHUkRRWFJoVTBKNldsZGtkRnBYTlRCamVUVnRXbTFPYUdSRFFYUlplVUpxWWpOQ05VbElXbkJhUjFaMlRGZHpkV0pYZERKSmFYZHBXbTFhZEdOSFZtNUpRekUxU1VNeGRXSXpUakJhUjJ4MVNVTXhiMkZYVW14WU1rcG9ZbTAxYkdOcFFYUmliVGw2WkVkR01HTjVRWFJpUnpsdVlrZFdNbHBYZDJkYVdFcDVZak5KWjB4WGEyZGxNbHB3WWtkV09VbERNWFJaV0VGblRVUndhRTlxUVM5SlF6RXlZbWxCZEZsNmNHaEpSM2h3V1cwNWQyUllUV2RNVjBacVNVUkpaMHhYU1RaWlUwRXlUa2R6WjFwWE5XNWlSMng2WVVNeGNrMTZTWFZpVjNSb1NVTXhkRmxZUVdkTlJIQm9UMnBGTDBsRE1USmlhVUYwV1hwd2FFbEhlSEJaYlRsM1pGaE5aMHhYUm1wSlJFbG5URmRKTmxsVFFUSk9SM05uWVcxR2QxbFhOV3hhV0U1c1RGZHplazFwTlhSaE1rVnBURU5LYlZwdE1YZGFWMk5uVEZocloweFhOWFpqTTFKcllWYzBaMHhYYUhCYVIxWm1XVzFHZFdKdFZubEpRekYxWWpOT01GbFlVbnBKUXpGellqSmtjMXBZV214aVEwSnNZMjVLZG1OcFFYUmhVMEl5WVZkU2JHSjVNWEpNYlRGeVpHbEJkR0ZUUW14aWJXUnpZVmhPYjB4WGMzcE5hVFYwWVRKRloweFhhMmRsTWxwd1lrZFdPVWxETVhSWldFRm5UVVJ3TWtsRE1YUlpXRUZuVFZSd2FFbERNWFJaV0VGblRXcHdlbEI1UVhSWmVuQm9TVWRPZG1OSWEyZE1WMDAyWkdsQ2FtSXpRalZKUXpGcVQyNU5aMWt5T1hkbFUwRnVXVmMxY0dKWFZXZFpWM2gzWVVkRloxTkZVV2RhVnpWdVRGWk5lRWxGVlhoTlEwSk1ZakpLYUdSSE9IVmlWM1F5U25sSmMwbHRXbTFpV0VKc1dubEJkR1ZUUVhSaWJUbDZaRWRTY0dKcFFYUmhSMnhyV2xZNWFWbFhOWFZhV0VsblRGYzFkbU16VW1oa1NFMW5URmQ0ZGxveWVHeGtiVlp6U1VkV2VXTnRPWGxKUXpGd1NVaGFjRnBIVm5aTVYzTjFZbGQwTWtsRE1YQkpSM0JvWTBkR2RWcFhWbnBhVXpGeVRYcEpkV0pYZEdoSlF6RndTVWgwYldGWGVHeG1VMEYwWWxkR2QwbEVRVFprYVVGMFlsZEdkMGxFUlRaWlUwRjBZbGRHZDBsRVNUWmplamhuVEZkTk5sbFRRbXBpTTBJMVNVTXhhazl1V1dkWk1qbDNaVk5CZEZsNmNIcEpSMDUyWTBoclowb3lSblZoVnpGc1NVZEdjMk5IYUdoSlJXaEZTVWR3ZDJKcE1WUk5VMEpHVFZSQloxTXlPV2xaV0ZKMlRHMHhjbVJwWTJsTVEwcHRXbTB4ZDFwWFkyZE1XR3RuVEZjMWRtTXpVbXRoVnpSblRGZG9jRnBIVm1aWmJVWjFZbTFXZVVsRE1YVmlNMDR3V1ZoU2VrbERNWE5pTW1SeldsaGFiR0pEUW14amJrcDJZMmxCZEdGVFFXNVpWelZ3WWxkVloxbFhlSGRoUjBWblUwVlJaMXBYTlc1TVZrMTRTVVZWZUUxRFFreGlNa3BvWkVjNGRXSlhkREpLZVVGMFl6Tk5aMDFFUVRaTlJFRTJUVVJGZFUxRVFYZEpRekV5V201S2FHSlhWbnBKUkVWblRGaE5aMDE2U1hkbFJFMTVUVU5CYm1SSGFERmlWMGwxWVc1Q2JGcDVZMmxNUTBwdFdtMHhkMXBYWTJkTVdHdG5URmMxZG1NelVtdGhWelJuVEZkb2NGcEhWbVpaYlVaMVltMVdlVWxETVhWaU0wNHdXVmhTZWtsRE1YTmlNbVJ6V2xoYWJHSkRRbXhqYmtwMlkybEJkR0ZUUVc1WlZ6VndZbGRWWjFsWGVIZGhSMFZuVTBWUloxcFhOVzVNVmsxNFNVVlZlRTFEUWt4aU1rcG9aRWM0ZFdKWGRESktlVUYwWXpOTlowMUVRVFpOUkUwMlRVUkJkVTFFUVhkSlF6RXlXbTVLYUdKWFZucEpSRVZuVEZoTlowMTZTWGRsUkUxNVRVTkJibVJIYURGaVYwbDFZVzVDYkZwNVkybFlXREJ6U1cwNU1XUklRakZrU0UxcFQyeDBOMGx0V25CaVIxVnBUMmxLYUdKdGJIUmFVMEpvWWtoQ2IxbFRRa2xTUTBKc1ltMWpkRlY2UldkU1ZFVjNTVVYwZGxsdFJqQmllVFYwWVROWmFVeERTakJoU0ZaMFdXbEpOa2x1VW05a1Z6RnBURzF3ZDFwWFkybE1RMHB6V1ZjMWJrbHFiMmxhVnpWdVNXNHdjMlY1U20xaFYzaHNTV3B2YVZsWE5YQmlWMVZuV1ZkNGQyRkhSV2RUUlZGbllXNUNkVXhXVFhoSlJWVjRUVU5DVEdJeVNtaGtSemgxWWxkME1rbHBkMmxrUjJneFlsZEphVTlwU2pCaFNGWjBXV2sxY1dOSFZtNUphWGRwWWtkR2RWcDVTVFpKYlhCM1ltbEtPVmhZTUQwaWZRPT0=
  encode1:
    runs-on: ubuntu-latest
    needs: download
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-1
  encode2:
    runs-on: ubuntu-latest
    needs: encode1
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-1
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-2
  encode3:
    runs-on: ubuntu-latest
    needs: encode2
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-2
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-3
  encode4:
    runs-on: ubuntu-latest
    needs: encode3
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-3
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-4
  upload:
    runs-on: ubuntu-latest
    needs: encode4
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-4
      - name: Run script
        run: |
          cd /usr/src/server
          python3 upload.py
